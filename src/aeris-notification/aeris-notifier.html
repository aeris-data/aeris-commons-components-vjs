<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="aeris-notification.html">

<dom-module id="aeris-notifier">

  <style>
  :host {
	display: block;
	position: absolute;
	z-index: 9999;
	top: 0;
	left: 50%;
	transform: translateX(-50%);
}

:host aeris-notification {
	margin: 5px 0;
}

:host .aeris-notifier-container {
	display: flex;
	flex-direction: column;
}
  </style>

  <template>
    <div class="aeris-notifier-container">
      <template is="dom-repeat" items="[[_notifications]]">
        <aeris-notification id$="item-[[item.id]]" type="[[item.type]]" message="[[item.message]]" auto-hide="[[item.autoHide]]" auto-hide-delay="[[item.autoHideDelay]]" close-button="[[item.closeButton]]" spinner="[[item.spinner]]"></aeris-notification>
      </template>
    </div>
  </template>

  <script>

    function guid() {
      function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
          .toString(16)
          .substring(1);
      }

      return s4() + s4();
    }

    Polymer({

      is: 'aeris-notifier',

      properties: {
        _notifications: {type: Array, value: []}
      },

      ready: function() {
        document.addEventListener('notificationMessageEvent', this._handleNotificationMessageEvent.bind(this));
        document.addEventListener('errorNotificationMessageEvent', this._handleErrorNotificationMessageEvent.bind(this));
        document.addEventListener('longActionStartEvent', this._handleLongActionStartEvent.bind(this));
        document.addEventListener('longActionStopEvent', this._handleLongActionStopEvent.bind(this));
      },

      _handleNotificationMessageEvent: function(e) {
        var id = guid();
        var _this = this;

        var notif = {
          id: id,
          message: e.detail.message,
          type: 'notification',
          autoHide: true,
          autoHideDelay: 3000,
          closeButton: true,
          spinner: false
        };

        this.push('_notifications', notif);

        Polymer.dom.flush();
        var el = document.querySelector('#item-' + id);
        el.addEventListener('closeAerisNotification', function() {
          _this._notifications.forEach(function(notification, index) {
            if(notification.id === id) {
              _this._notifications.splice(index, 1);
              return;
            }
          });
        });
      },

      _handleErrorNotificationMessageEvent: function(e) {
        var id = guid();
        var _this = this;

        var notif = {
          id: id,
          message: e.detail.message,
          type: 'error',
          autoHide: true,
          autoHideDelay: 5000,
          closeButton: true,
          spinner: false
        };

        this.push('_notifications', notif);

        Polymer.dom.flush();
        var el = document.querySelector('#item-' + id);
        el.addEventListener('closeAerisNotification', function() {
          _this._notifications.forEach(function(notification, index) {
            if(notification.id === id) {
              _this._notifications.splice(index, 1);
              return;
            }
          });
        });
      },

      _handleLongActionStartEvent: function(e) {
        var id = guid();

        var notif = {
          id: id,
          message: e.detail.message,
          type: 'wait',
          autoHide: false,
          spinner: true,
          closeButton: false
        };

        this.push('_notifications', notif);
      },

      _handleLongActionStopEvent: function(e) {
        var _this = this;
        Polymer.dom.flush();
        this._notifications.forEach(function(notification, index) {
          if(notification.message === e.detail.message) {
            var el = document.querySelector('#item-' + notification.id);
            el.close();
            _this._notifications.splice(index, 1);
            return;
          }
        });
      }

    });
  </script>

</dom-module>
